(ns phel-aa\image-reader\tests
  (:require phel\test :refer [deftest is])
  (:require phel-aa\char-block)
  (:require phel-aa\image-reader))

(def material-directory (format "%s/../material" __DIR__))

(deftest a-image-diff
  (let [filename (format "%s/%d.png" material-directory (php/ord "A"))
        im (php/imagecreatefrompng filename)
        hist (map (fn [[x y]]
                    (let [rgb (php/imagecolorat im x y)]
                      (char-block/get-rgb-average rgb)))
                  (char-block/get-points))]
    (is (= [249 248 239 238 251 233 119 74 219 251 239 156 82 206 251 250 249 246 245 251 254 253 252 252 252] hist))))

(deftest php-logo-image-get-block-points
  (let [filename "tests/PHP-logo.png"
        blocks (image-reader/get-block-points filename)]
    (is (= 12 (count blocks)))
    (is (= 23 (count (blocks 0))))
    (let [p00 (get-in blocks [0 0])]
      (is (= 0 (p00 :w))) 
      (is (= 0 (p00 :h))))
    (let [p01 (get-in blocks [0 1])]
      (is (= 1 (p01 :w))) 
      (is (= 0 (p01 :h))))))

(deftest php-logo-image-block-point-to-hist
  (let [filename "tests/PHP-logo.png"
        image (image-reader/create-image filename)
        block-position (image-reader/block-position 0 0)
        hist (image-reader/convert-to-hist image block-position)]
    (is (= [255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255] hist))))

